{"version":3,"file":"in2iframeconsent.modern.js","sources":["../../src/CookieManager.ts","../../src/index.ts"],"sourcesContent":["import { Cookie } from './types';\n\nexport default class CookieManager {\n  public static getCookie(name: string): string {\n    const b = document.cookie.match(`(^|;)\\\\s*${name}\\\\s*=\\\\s*([^;]+)`);\n\n    if (b) return b.pop() || '';\n    return '';\n  }\n\n  public static setCookie({ name, value, expirationYears }: Cookie): void {\n    const domain = window.location.hostname;\n\n    const expirationDate = new Date();\n    expirationDate.setFullYear(expirationDate.getFullYear() + expirationYears);\n    const expirationDateString = expirationDate.toUTCString();\n\n    document.cookie = `${name}=${value};expires=${expirationDateString};domain=${domain};path=/;SameSite=None;secure`;\n  }\n\n  public static deleteCookie(name: string): void {\n    this.setCookie({\n      name,\n      value: 'nothing',\n      expirationYears: -100,\n    });\n  }\n}\n","import { IframeDataAttribute } from './types';\nimport CookieManager from './CookieManager';\n\nclass In2iframeswitch {\n  private cookieName: string = 'iframeswitch';\n\n  private expirationYears: number = 10;\n\n  constructor() {\n    this.addButtonEvents();\n    this.autoEnableIframes();\n    In2iframeswitch.addDomainInformation();\n\n    window.iframeSwitch = window.iframeSwitch || {};\n  }\n\n  /**\n     * Replaces iFrameconsentbox with correct iFrame\n     * @param container\n     * @private\n     */\n  private static changeElementToIframe(container: HTMLElement): void {\n    const attributes = In2iframeswitch.getAllDataAttributes(container);\n    const iframe = document.createElement('iframe');\n\n    attributes.forEach((attribute) => {\n      iframe.setAttribute(\n        attribute.name,\n        attribute.value,\n      );\n    });\n\n    const parentNode = container.parentNode as HTMLElement;\n    parentNode.insertBefore(iframe, container);\n    parentNode.classList.remove('iframeswitch-init');\n    parentNode.removeChild(container);\n  }\n\n  /**\n     * Enable Iframe, if src of the iframe is set in cookie for iframeswitch\n     * @private\n     */\n  private autoEnableIframes(): void {\n    const elements = document.querySelectorAll<HTMLElement>('[data-iframeswitch-src]');\n    const cookieString = CookieManager.getCookie(this.cookieName);\n    const activeCookies: string[] = cookieString.split(',');\n\n    elements.forEach((element) => {\n      if (activeCookies.includes('*')) {\n        In2iframeswitch.changeElementToIframe(element);\n        return;\n      }\n\n      const iframeURL:string | null = element.getAttribute('data-iframeswitch-src');\n\n      if (iframeURL) {\n        const iframeSource = In2iframeswitch.extractHostname(iframeURL);\n\n        activeCookies.forEach((currentCookie) => {\n          if (currentCookie === iframeSource) {\n            In2iframeswitch.changeElementToIframe(element);\n          }\n        });\n      }\n    });\n  }\n\n  /**\n     * Replace <span data-iframeswitch-uri=\"true\"></span> with the iFrame URL.\n     * So it can be used inside the container\n     */\n  private static addDomainInformation(): void {\n    const elements = document.querySelectorAll<HTMLElement>('[data-iframeswitch-uri]');\n    elements.forEach((element) => {\n      const parent = In2iframeswitch.closest(\n          element,\n          '[data-iframeswitch-src]',\n      );\n\n      if (parent) {\n        const parentSrc = parent.getAttribute('data-iframeswitch-src') || 'error, domain not found';\n        element.innerHTML = In2iframeswitch.extractHostname(parentSrc);\n      }\n    });\n  }\n\n  private addButtonEvents(): void {\n    const elements = document.querySelectorAll<HTMLElement>('[data-iframeswitch-src]');\n\n    elements.forEach((element) => {\n      const elementStart = element.querySelector('[data-iframeswitch-submit]');\n\n      if (elementStart) {\n        elementStart.addEventListener(\n            'click',\n            (event) => {\n              const currentCookies = CookieManager.getCookie(this.cookieName);\n              if (currentCookies === '*') return;\n\n              const container = In2iframeswitch.closest(\n                  event.target as HTMLElement,\n                  '[data-iframeswitch-src]',\n              );\n              if (!container) return;\n\n              const iframeSwitchURL = container.getAttribute('data-iframeswitch-src');\n              if (!iframeSwitchURL) return;\n\n              const newCookie = In2iframeswitch.extractHostname(iframeSwitchURL);\n\n              CookieManager.setCookie({\n                name: this.cookieName,\n                value: currentCookies.length > 0 ? `${currentCookies},${newCookie}` : newCookie,\n                expirationYears: this.expirationYears,\n              })\n\n              this.autoEnableIframes();\n            },\n        );\n      }\n    });\n  }\n\n  /**\n     * JavaScript pendent to jQuerys closest() function\n     */\n  private static closest(element: HTMLElement, selector: string): HTMLElement | null {\n    let matchesFn;\n\n    // find vendor prefix\n    [\n      'matches',\n      'webkitMatchesSelector',\n      'mozMatchesSelector',\n      'msMatchesSelector',\n      'oMatchesSelector',\n    ].some((fn) => {\n      // @ts-ignore\n      if (typeof document.body[fn] === 'function') {\n        matchesFn = fn;\n        return true;\n      }\n      return false;\n    });\n\n    let parent: HTMLElement;\n\n    // traverse parents\n    while (element) {\n      // @ts-ignore\n      parent = element.parentElement;\n      // @ts-ignore\n      if (parent && parent[matchesFn](selector)) {\n        return parent;\n      }\n      element = parent;\n    }\n\n    return null;\n  }\n\n  private static getAllDataAttributes(container: HTMLElement): IframeDataAttribute[] {\n    const attributes: {name: string, value: string}[] = [];\n\n    Array.from(container.attributes).forEach((attribute) => {\n      if (attribute.name.indexOf('data-iframeswitch-') !== -1) {\n        attributes.push({\n          name: attribute.name.replace('data-iframeswitch-', ''),\n          value: attribute.value,\n        });\n      }\n    });\n\n    return attributes;\n  }\n\n  private static extractHostname(url: string): string {\n    let hostname: string;\n\n    if (url.indexOf('//') > -1) {\n      hostname = url.split('/')[2];\n    } else {\n      hostname = url.split('/')[0];\n    }\n\n    hostname = hostname.split(':')[0];\n    hostname = hostname.split('?')[0];\n\n    return hostname || '';\n  }\n\n  /**\n     * Enables all iFrameConsents\n     */\n  public enableAll(): void {\n    CookieManager.setCookie({\n      name: this.cookieName,\n      value: '*',\n      expirationYears: this.expirationYears,\n    });\n\n    this.autoEnableIframes();\n  }\n\n  /**\n     * Disables all accepted iFrameConsents and deletes all in2iframeconsent Cookies\n     */\n  public disableAll(): void {\n    CookieManager.deleteCookie(this.cookieName);\n  }\n}\n\n// eslint-disable-next-line no-new\nnew In2iframeswitch();\n"],"names":["CookieManager","static","name","b","document","cookie","match","pop","value","expirationYears","domain","window","location","hostname","expirationDate","Date","setFullYear","getFullYear","expirationDateString","toUTCString","this","setCookie","In2iframeswitch","constructor","cookieName","addButtonEvents","autoEnableIframes","addDomainInformation","iframeSwitch","container","attributes","getAllDataAttributes","iframe","createElement","forEach","attribute","setAttribute","parentNode","insertBefore","classList","remove","removeChild","elements","querySelectorAll","activeCookies","getCookie","split","element","includes","changeElementToIframe","iframeURL","getAttribute","iframeSource","extractHostname","currentCookie","parent","closest","parentSrc","innerHTML","elementStart","querySelector","addEventListener","event","currentCookies","target","iframeSwitchURL","newCookie","length","selector","matchesFn","some","fn","body","parentElement","Array","from","indexOf","push","replace","url","enableAll","disableAll","deleteCookie"],"mappings":"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"}